<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.visualization.tools.interaction_radius_plot &mdash; tardis</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/plot_directive.css" type="text/css" />
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
              <div class="version">
                latest
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/spectrum/index.html">Spectrum Generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.visualization.tools.interaction_radius_plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.visualization.tools.interaction_radius_plot</h1><div class="highlight"><pre>
<span></span>import matplotlib.pyplot as plt
import matplotlib.cm as cm
import plotly.graph_objects as go
import numpy as np
import pandas as pd
import astropy.units as u

from tardis.util.base import (
    atomic_number2element_symbol,
    int_to_roman,
)
import tardis.visualization.tools.sdec_plot as sdec
from tardis.visualization import plot_util as pu


<div class="viewcode-block" id="InteractionRadiusPlotter"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.interaction_radius_plot.html#tardis.visualization.tools.interaction_radius_plot.InteractionRadiusPlotter">[docs]</a>class InteractionRadiusPlotter:
    &quot;&quot;&quot;
    Plotting interface for the interaction radius plot.
    &quot;&quot;&quot;

    def __init__(self, data, time_explosion, velocity):
        &quot;&quot;&quot;
        Initialize the plotter with required data from the simulation.

        Parameters
        ----------
        data : dict of SDECData
            Dictionary to store data required for interaction radius plot,
            for both packet modes (real, virtual).

        time_explosion : astropy.units.Quantity
            Time of the explosion.

        velocity : astropy.units.Quantity
            Velocity array from the simulation.
        &quot;&quot;&quot;

        self.data = data
        self.time_explosion = time_explosion
        self.velocity = velocity
        self.sdec_plotter = sdec.SDECPlotter(data)

<div class="viewcode-block" id="InteractionRadiusPlotter.from_simulation"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.interaction_radius_plot.html#tardis.visualization.tools.interaction_radius_plot.InteractionRadiusPlotter.from_simulation">[docs]</a>    @classmethod
    def from_simulation(cls, sim):
        &quot;&quot;&quot;
        Create an instance of the plotter from a TARDIS simulation object.

        Parameters
        ----------
        sim : tardis.simulation.Simulation
            TARDIS simulation object produced by running a simulation.

        Returns
        -------
        InteractionRadiusPlotter
        &quot;&quot;&quot;

        return cls(
            dict(
                virtual=sdec.SDECData.from_simulation(sim, &quot;virtual&quot;),
                real=sdec.SDECData.from_simulation(sim, &quot;real&quot;),
            ),
            sim.plasma.time_explosion,
            sim.simulation_state.velocity,
        )</div>

<div class="viewcode-block" id="InteractionRadiusPlotter.from_hdf"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.interaction_radius_plot.html#tardis.visualization.tools.interaction_radius_plot.InteractionRadiusPlotter.from_hdf">[docs]</a>    @classmethod
    def from_hdf(cls, hdf_fpath):
        &quot;&quot;&quot;
        Create an instance of the Plotter from a simulation HDF file.

        Parameters
        ----------
        hdf_fpath : str
            Valid path to the HDF file where simulation is saved.

        Returns
        -------
        InteractionRadiusPlotter
        &quot;&quot;&quot;
        hdfstore = pd.HDFStore(hdf_fpath)
        time_explosion = (
            hdfstore[&quot;/simulation/plasma/scalars&quot;][&quot;time_explosion&quot;] * u.s
        )
        velocity = (
            hdfstore[&quot;/simulation/simulation_state&quot;][&quot;velocity&quot;] * u.cm / u.s
        )
        return cls(
            dict(
                virtual=sdec.SDECData.from_hdf(hdf_fpath, &quot;virtual&quot;),
                real=sdec.SDECData.from_hdf(hdf_fpath, &quot;real&quot;),
            ),
            time_explosion,
            velocity,
        )</div>

    def _parse_species_list(self, species_list):
        &quot;&quot;&quot;
        Parse user requested species list and create list of species ids to be used.

        Parameters
        ----------
        species_list : list of species to plot
            List of species (e.g. Si II, Ca II, etc.) that the user wants to show as unique colours.
            Species can be given as an ion (e.g. Si II), an element (e.g. Si), a range of ions
            (e.g. Si I - V), or any combination of these (e.g. species_list = [Si II, Fe I-V, Ca])

        Raises
        ------
        ValueError
            If species list contains invalid entries.

        &quot;&quot;&quot;
        self.sdec_plotter._parse_species_list(species_list)
        self._species_list = self.sdec_plotter._species_list
        self._species_mapped = self.sdec_plotter._species_mapped
        self._keep_colour = self.sdec_plotter._keep_colour

    def _make_colorbar_labels(self):
        &quot;&quot;&quot;
        Generate labels for the colorbar based on species.

        If a species list is provided, uses that to generate labels.
        Otherwise, generates labels from the species in the model.
        &quot;&quot;&quot;
        if self._species_list is None:
            species_name = [
                atomic_number2element_symbol(atomic_num)
                for atomic_num in self.species
            ]
        else:
            species_name = []
            for species_key, species_ids in self._species_mapped.items():
                if any(species in self.species for species in species_ids):
                    if species_key % 100 == 0:
                        label = atomic_number2element_symbol(species_key // 100)
                    else:
                        atomic_number = species_key // 100
                        ion_number = species_key % 100
                        ion_numeral = int_to_roman(ion_number + 1)
                        label = f&quot;{atomic_number2element_symbol(atomic_number)} {ion_numeral}&quot;
                    species_name.append(label)

        self._species_name = species_name

    def _make_colorbar_colors(self):
        &quot;&quot;&quot;
        Generate colors for the species to be plotted.

        Creates a list of colors corresponding to the species names.
        &quot;&quot;&quot;
        color_list = []
        species_keys = list(self._species_mapped.keys())
        num_species = len(species_keys)

        for species_counter, species_key in enumerate(species_keys):
            if any(
                species in self.species
                for species in self._species_mapped[species_key]
            ):
                color = self.cmap(species_counter / num_species)
                color_list.append(color)

        self._color_list = color_list

    def _generate_plot_data(self, packets_mode):
        &quot;&quot;&quot;
        Generate plot data and colors for species in the model.

        Parameters
        ----------
        packets_mode : str
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;.

        Returns
        -------
        plot_data : list
            List of velocity data for each species.

        plot_colors : list
            List of colors corresponding to each species.
        &quot;&quot;&quot;
        groups = self.data[packets_mode].packets_df_line_interaction.groupby(
            by=&quot;last_line_interaction_species&quot;
        )

        plot_colors = []
        plot_data = []
        species_counter = 0

        for specie_list in self._species_mapped.values():
            full_v_last = []
            for specie in specie_list:
                if specie in self.species:
                    g_df = groups.get_group(specie)
                    r_last_interaction = (
                        g_df[&quot;last_interaction_in_r&quot;].values * u.cm
                    )
                    v_last_interaction = (
                        r_last_interaction / self.time_explosion
                    ).to(&quot;km/s&quot;)
                    full_v_last.extend(v_last_interaction)
            if full_v_last:
                plot_data.append(full_v_last)
                plot_colors.append(self._color_list[species_counter])
                species_counter += 1

        return plot_data, plot_colors

    def _prepare_plot(self, packets_mode, species_list, cmapname):
        &quot;&quot;&quot;
        Helper function to prepare the plot data and colors.

        Parameters
        ----------
        packets_mode : str
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;.
        species_list : list of str
            List of species to plot.

        Raises
        ------
        ValueError
            If no species provided or no valid species found.

        &quot;&quot;&quot;
        self._parse_species_list(species_list)
        species_in_model = np.unique(
            self.data[packets_mode]
            .packets_df_line_interaction[&quot;last_line_interaction_species&quot;]
            .values
        )
        if self._species_list is None or not self._species_list:
            raise ValueError(&quot;No species provided for plotting.&quot;)
        msk = np.isin(self._species_list, species_in_model)
        self.species = np.array(self._species_list)[msk]

        if len(self.species) == 0:
            raise ValueError(&quot;No valid species found for plotting.&quot;)

        self._make_colorbar_labels()
        self.cmap = cm.get_cmap(cmapname, len(self._species_name))
        self._make_colorbar_colors()

<div class="viewcode-block" id="InteractionRadiusPlotter.generate_plot_mpl"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.interaction_radius_plot.html#tardis.visualization.tools.interaction_radius_plot.InteractionRadiusPlotter.generate_plot_mpl">[docs]</a>    def generate_plot_mpl(
        self,
        packets_mode=&quot;virtual&quot;,
        ax=None,
        figsize=(11, 5),
        cmapname=&quot;jet&quot;,
        species_list=None,
        log_scale=False,
        bins_range=None,
    ):
        &quot;&quot;&quot;
        Generate the last interaction radius distribution plot using matplotlib.

        Parameters
        ----------
        packets_mode : str, optional
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;. Default is &#39;virtual&#39;.
        ax : matplotlib.axes.Axes, optional
            Axes object to plot on. If None, creates a new figure.
        figsize : tuple, optional
            Size of the figure. Default is (11, 6).
        cmapname : str, optional
            Colormap name. Default is &#39;jet&#39;. A specific colormap can be chosen, such as &quot;jet&quot;, &quot;viridis&quot;, &quot;plasma&quot;, etc.
        species_list : list of str
            List of species to plot.
        log_scale : bool, optional
            If True, both axes are scaled logarithmically. Default is False.
        bins_range : tuple of int, optional
            Range of bins to plot, e.g., (3, 9). Default is None, which plots all bins.

        Returns
        -------
        matplotlib.axes.Axes
            Axes object with the plot.
        &quot;&quot;&quot;
        self._prepare_plot(packets_mode, species_list, cmapname)
        plot_data, plot_colors = self._generate_plot_data(packets_mode)
        bin_edges = (self.velocity).to(&quot;km/s&quot;)

        if bins_range:
            bin_edges = bin_edges[bins_range[0] - 1 : bins_range[1] + 1]

        if ax is None:
            self.ax = plt.figure(figsize=figsize).add_subplot(111)
        else:
            self.ax = ax

        for data, color, name in zip(
            plot_data, plot_colors, self._species_name
        ):
            hist, _ = np.histogram(data, bins=bin_edges)
            step_x = np.repeat(bin_edges, 2)[1:-1]
            step_y = np.repeat(hist, 2)
            self.ax.plot(
                step_x,
                step_y,
                label=name,
                color=color,
                linewidth=2.5,
                drawstyle=&quot;steps-post&quot;,
                alpha=0.75,
            )

        self.ax.ticklabel_format(axis=&quot;y&quot;, scilimits=(0, 0))
        self.ax.tick_params(&quot;both&quot;, labelsize=14)
        self.ax.set_xlabel(&quot;Last Interaction Velocity (km/s)&quot;, fontsize=14)
        self.ax.set_ylabel(&quot;Packet Count&quot;, fontsize=14)
        self.ax.grid(True, which=&quot;both&quot;, linestyle=&quot;--&quot;, linewidth=0.5)
        self.ax.legend(fontsize=15)
        plt.legend(bbox_to_anchor=(1.0, 1.0), loc=&quot;upper left&quot;)
        if log_scale:
            self.ax.set_xscale(&quot;log&quot;)
            self.ax.set_yscale(&quot;log&quot;)
        plt.tight_layout()

        return self.ax</div>

<div class="viewcode-block" id="InteractionRadiusPlotter.generate_plot_ply"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.interaction_radius_plot.html#tardis.visualization.tools.interaction_radius_plot.InteractionRadiusPlotter.generate_plot_ply">[docs]</a>    def generate_plot_ply(
        self,
        packets_mode=&quot;virtual&quot;,
        fig=None,
        graph_height=500,
        cmapname=&quot;jet&quot;,
        species_list=None,
        log_scale=False,
        bins_range=None,
    ):
        &quot;&quot;&quot;
        Generate the last interaction radius distribution plot using plotly.

        Parameters
        ----------
        packets_mode : str, optional
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;. Default is &#39;virtual&#39;.
        fig : plotly.graph_objects.Figure, optional
            Plotly figure object to add the plot to. If None, creates a new figure.
        graph_height : int, optional
            Height of the graph in pixels. Default is 500.
        cmapname : str, optional
            Colormap name. Default is &#39;jet&#39;. A specific colormap can be chosen, such as &quot;jet&quot;, &quot;viridis&quot;, &quot;plasma&quot;, etc.
        species_list : list of str
            List of species to plot.
        log_scale : bool, optional
            If True, both axes are scaled logarithmically. Default is False.
        bins_range : tuple of int, optional
            Range of bins to plot, e.g., (3, 9). Default is None, which plots all bins.

        Returns
        -------
        plotly.graph_objects.Figure
            Plotly figure object with the plot.
        &quot;&quot;&quot;
        self._prepare_plot(packets_mode, species_list, cmapname)
        plot_data, plot_colors = self._generate_plot_data(packets_mode)
        bin_edges = (self.velocity).to(&quot;km/s&quot;)

        if bins_range:
            bin_edges = bin_edges[bins_range[0] - 1 : bins_range[1] + 1]

        fig = go.Figure()

        for data, color, name in zip(
            plot_data, plot_colors, self._species_name
        ):
            hist, _ = np.histogram(data, bins=bin_edges)
            step_x = np.repeat(bin_edges, 2)[1:-1]
            step_y = np.repeat(hist, 2)
            fig.add_trace(
                go.Scatter(
                    x=step_x,
                    y=step_y,
                    mode=&quot;lines&quot;,
                    line=dict(
                        color=pu.to_rgb255_string(color),
                        width=2.5,
                        shape=&quot;hv&quot;,
                    ),
                    name=name,
                    opacity=0.75,
                )
            )
        fig.update_layout(
            height=graph_height,
            xaxis_title=&quot;Last Interaction Velocity (km/s)&quot;,
            yaxis_title=&quot;Packet Count&quot;,
            font=dict(size=14),
            yaxis=dict(exponentformat=&quot;power&quot; if log_scale else &quot;e&quot;),
            xaxis=dict(exponentformat=&quot;power&quot; if log_scale else &quot;none&quot;),
        )
        if log_scale:
            fig.update_xaxes(type=&quot;log&quot;)
            fig.update_yaxes(type=&quot;log&quot;, dtick=1)

        return fig</div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2024, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 28 Jun 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>